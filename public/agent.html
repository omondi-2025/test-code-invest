<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Testcode | Agent Panel</title>
  <style>
    :root {
      --darkblue: #001f54;
      --lightblue: #e6f2ff;
      --silver: #c0c0c0;
      --green: #4caf50;
    }
	
	.referral-banner {
  background: linear-gradient(90deg, #00C851, #33b5e5, #007E33);
  color: white;
  padding: 1rem;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  border-radius: 10px;
  margin-top: 1rem;
  animation: popFade 0.4s ease-in-out;
}

@keyframes popFade {
  0% { opacity: 0; transform: scale(0.95); }
  100% { opacity: 1; transform: scale(1); }
}

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--lightblue);
      margin: 0;
      padding: 1rem;
    }

    header {
      background-color: var(--darkblue);
      color: white;
      padding: 1rem;
      text-align: center;
      border-radius: 8px;
    }

    .summary, .referral-box {
      margin-top: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .summary h3, .referral-box h3 {
      margin: 0.5rem 0;
      color: var(--darkblue);
    }

    .referral-link {
      background-color: #f1f1f1;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      word-break: break-word;
      border-radius: 5px;
    }

    .referral-box button {
      background-color: var(--darkblue);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .referral-box button:hover {
      background-color: #003b8b;
    }

    .referral-table {
      margin-top: 1rem;
      width: 100%;
      border-collapse: collapse;
    }

    .referral-table th, .referral-table td {
      border: 1px solid var(--silver);
      padding: 0.75rem;
      text-align: left;
    }

    .referral-table th {
      background-color: var(--darkblue);
      color: white;
    }

    .referral-table tbody td {
      background-color: white;
    }

    .footer-btn {
      text-align: center;
      margin-top: 2rem;
    }

    .footer-btn button {
      background-color: var(--darkblue);
      color: white;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .footer-btn button:hover {
      background-color: #003b8b;
    }

    @media (max-width: 600px) {
      .referral-table th, .referral-table td {
        font-size: 0.85rem;
      }
    }
	
	.whatsapp-btn {
  display: inline-block;
  background: linear-gradient(45deg, #25D366, #128C7E);
  color: white;
  padding: 0.8rem 1.4rem;
  font-size: 1rem;
  font-weight: bold;
  border-radius: 30px;
  text-decoration: none;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  animation: bounceBtn 1.8s infinite;
  transition: transform 0.2s ease;
}

.whatsapp-btn:hover {
  transform: scale(1.05);
}

@keyframes bounceBtn {
  0%, 100% { transform: translateY(0); }
  50%      { transform: translateY(-5px); }
}

@keyframes fadeOut {
  0% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; }
}

  </style>
</head>
<body>
  <header>
    <h2>Referral Agent Panel</h2>
  </header>

  <div class="summary">
    <h3>Total Referrals: <span id="totalReferrals">0</span></h3>
    <h3>Total Commission Earned: KES <span id="totalCommission">0.00</span></h3>
  </div>
  
 <div class="referral-banner">
  üí∏ Earn <span style="color: #FFD700;">20%</span> commission when you invite a friend who invests!
</div>

  <div class="referral-box">
    <h3>Your Referral Link:</h3>
    <div class="referral-link">
  <span id="referralLink" style="color: #001f54; text-decoration: underline;">Generating...</span>
</div>
    <button onclick="copyReferral()">üìã Copy Referral Link</button>
	<button class="whatsapp-btn" onclick="shareReferral()">üì§ Share on WhatsApp</button>
  </div>
  <p style="margin-top: 0.8rem; color: #007E33; font-weight: bold; font-size: 1rem;">
  üì¢ Invite a friend and earn <span style="color: #FFD700;">20%</span> of their first investment!
</p>

  <table class="referral-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Investment üí∞</th>
        <th>Your Commission üéÅ</th>
      </tr>
    </thead>
    <tbody id="referralBody">
      <tr>
        <td colspan="4" style="text-align: center;">Loading referrals...</td>
      </tr>
    </tbody>
  </table>

  <div class="footer-btn">
    <button onclick="window.location.href='index.html'">‚¨ÖÔ∏è Back to Dashboard</button>
  </div>

  <script>
    function copyReferral() {
      const link = document.getElementById("referralLink").textContent;
      navigator.clipboard.writeText(link).then(() => {
        alert("‚úÖ Referral link copied!");
      }).catch(() => {
        alert("‚ùå Failed to copy. Please copy manually.");
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const user = JSON.parse(localStorage.getItem("user")) || JSON.parse(sessionStorage.getItem("user"));

      if (!user || !user.refCode) {
        alert("You must be logged in to view this page.");
        window.location.href = "login.html";
        return;
      }

      const referralURL = `${window.location.origin}/signup.html?ref=${user.refCode}`;
const referralLinkElem = document.getElementById("referralLink");
referralLinkElem.textContent = referralURL;
referralLinkElem.textContent = referralURL;

      try {
        const res = await fetch(`/api/agent/${user.refCode}`);
        const data = await res.json();

        const tbody = document.getElementById("referralBody");
        const totalReferrals = document.getElementById("totalReferrals");
        const totalCommission = document.getElementById("totalCommission");

        if (!data.success || !Array.isArray(data.referrals) || data.referrals.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: gray;">No referrals yet.</td></tr>`;
          return;
        }

        let commissionSum = 0;
        tbody.innerHTML = data.referrals.map(r => {
          commissionSum += r.commission || 0;
          return `
            <tr>
              <td>${r.fullName || "-"}</td>
              <td>${r.email || "-"}</td>
              <td>KES ${(r.investment || 0).toFixed(2)}</td>
              <td>KES ${(r.commission || 0).toFixed(2)}</td>
            </tr>
          `;
        }).join("");

        totalReferrals.textContent = data.referrals.length;
        totalCommission.textContent = commissionSum.toFixed(2);
      } catch (err) {
        console.error("Error loading referrals:", err);
        document.getElementById("referralBody").innerHTML = `
          <tr><td colspan="6" style="text-align: center; color: red;">‚ùå Failed to load referral data.</td></tr>
        `;
      }
    });
	function shareReferral() {
  const link = document.getElementById("referralLink").textContent;
  const message = `Join me on Testcode and earn! Use my referral link to sign up: ${link}`;
  const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappURL, '_blank');

  // Show popup
  const popup = document.getElementById('invite-popup');
  popup.style.display = 'block';
  setTimeout(() => {
    popup.style.display = 'none';
  }, 3000);
}

  </script>
  <div id="invite-popup" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #28a745;
  color: white;
  padding: 15px 25px;
  border-radius: 25px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 999;
  animation: fadeOut 3s forwards;
">
  ‚úÖ Invite shared! Earn 20% when your friend invests!
</div>

</body>
</html>